<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Revisiting the Outbox Pattern in Go</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/theme/sky.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <style>
        /* Keep existing heading text-transform override */
        h1, h2, h3, h4, h5, h6 {
            text-transform: none !important; /* Remove uppercase styling */
        }

        /* Remove extra lines from <pre> and <code> */
        pre, code {
            margin: 0 !important;
            padding: 0 !important;
            font-size: 0.8em !important; /* Adjust font size as needed */
            line-height: 1; /* Improve readability */
        }

        /* Enable auto-resize for sections */
        .reveal section {
            overflow: auto !important; /* Enable scrolling for overflowing content */
            padding: 0; /* Remove extra padding */
        }

        /* Prevent unnecessary space in syntax highlighting */
        code[class*="language-"] {
            white-space: pre !important; /* Maintain preformatted text */
        }

        ul ul {
            font-size: 80%;
        }

    </style>

</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h3>Revisiting the Outbox Pattern in Go</h3>
            <p style="font-size: 0.95em;">ContainerDays Hamburg</p>
            <p style="font-size: 0.8em;">10 Sep 2025</p>
            <p>Nikolay Kuznetsov</p>
            <img src="images/gopher.png" alt=""
                 style="position: absolute; top: 50%; left: 72%; transform: translate(-50%, -50%); width: 140px;">
        </section>

        <section>
            <h2>About me</h2>
            <p>Senior Software Engineer</p>
            <p><span style="color: orange;">Zalando</span> Helsinki ðŸ‡«ðŸ‡®</p>
            <p>C â†’ Java â†’ Kotlin â†’ Go</p>
            <p>Author of <a href="https://github.com/nikolayk812/pgx-outbox">pgx-outbox</a> library</p>
        </section>

        <section>
            <h2>Talk inspirations</h2>
            <p>Revisiting the Outbox Pattern - Gunnar Morling</p>
            <p>Personal experience</p>
            <p>Company experience</p>
        </section>

        <section>
            <h2>Dual write problem</h2>
            <img src="images/dual_write.png" alt="" height="500">
        </section>

        <section>
            <h2>Dual write problem</h2>
            <p><i>Service A</i> writes to DB and message broker</p>
            <p><b>Inconsistent</b> system state if any of writes fails</p>
        </section>


        <section>
            <h2>Naive approaches</h2>
            <p>â–ª Write to DB first, then send to broker</p>
            <p>â–ª Send to broker first, then write to DB</p>
            <p>â–ª Send to broker within DB tx before commit</p>
        </section>

        <section>
            <h2>Database first</h2>
            <img src="images/db_first.png" alt="" height="500">
        </section>

        <section>
            <h2>Broker first</h2>
            <img src="images/broker_first.png" alt="" height="500">
        </section>

        <section>
            <h2>Send inside DB tx</h2>
            <img src="images/tx_send.png" alt="" height="500">
        </section>

        <section>
            <h2>Transactional outbox pattern</h2>
            <img src="images/outbox_pattern.png" alt="" height="500">
        </section>

        <section>
            <h2>Outbox table example</h2>
            <pre><code class="language-sql">
 CREATE TABLE outbox (

     id           BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,

     payload      JSONB                               NOT NULL,

     created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

     -- additional metadata: event type, domain object type and id, topic
 );</code></pre>
        </section>


        <section>
            <h2>Outbox pattern pros</h2>
            <p>one of solutions to dual write problem</p>
            <p>âž• <i>Atomicity</i> between orders and outbox messages</p>
            <p>âž• At least once delivery to message broker</p>
        </section>

        <section>
            <h2>Outbox pattern cons</h2>
            <p>âž– Message publication delay</p>
            <p>âž– Extra code or deployment unit</p>
            <p>âž– Consumer might need to deduplicate</p>
            <p>âž– Increased database load</p>
        </section>

        <section>
            <h2>Reading from outbox</h2>
            <img src="images/outbox_table.png" alt="" height="100">
            <p>â–ª Periodic polling</p>
            <p style="font-size: 0.9em;">â–ª Log-based change data capture (CDC)</p>
        </section>

        <section>
            <h2>Periodic polling</h2>
            <ol style="list-style-type: none;">
                <li>â–ª SELECT (with LIMIT)</li>
                <li>
                    â–ª Options to mark published:

                    <ol style="list-style-type: lower-alpha;">
                        <li>DELETE by ids</li>
                        <li>UPDATE <i>published_at</i> by ids</li>
                        <li>Store latest id in a separate table</li>
                    </ol>
                </li>
            </ol>
        </section>

        <section>
            <h2>Go libs with polling</h2>
            <p>â–ª Watermill-SQL</p>
            <p>â–ª pgx-outbox</p>
            <p>â–ª go-outbox, â–ª outboxer</p>
            <p>general purpose queues: â–ª River, etc</p>
        </section>

        <section>
            <h2>pgx-outbox</h2>
            <p>Strong focus on <i>Postgres</i> and <i>pgx</i> driver</p>
            <p>Implements <i>Message</i>, <i>Writer</i>, <i>Forwarder</i></p>
            <p style="font-size: 0.95em;">UPDATE approach to mark published messages</p>
            <p style="font-size: 0.9em;">Inspired by Watermill Forwarder</p>
        </section>

        <section>
            <h2>pgx-outbox architecture</h2>
            <img src="images/pgx_outbox.png" alt="" height="500">
        </section>

        <section>
            <h2>Outbox Writer</h2>
            <pre><code class="language-golang">
 type Writer interface {

     // supports both pgx.Tx and stdlib *sql.Tx
     Write(ctx, tx Tx, message Message) (int64, error)

     // pgx transaction only to invoke SendBatch and Prepare methods
     WriteBatch(ctx, tx pgx.Tx, messages []Message) ([]int64, error)

 }</code></pre>
        </section>

        <section>
            <h2>Tracing with otelpgx</h2>
            <img src="images/tracing.png" alt="" height="200">
        </section>

        <section>
            <h2>Polling cons</h2>
            <p>âž– Low publication delay vs polling too often</p>
            <p>âž– Risk of starving other workloads under high traffic</p>
            <p>âž– UPDATE and DELETE create dead tuples (MVCC)</p>
            <p>âž– Autovacuum settings might need tuning</p>
        </section>

        <section>
            <h2>Log-based CDC</h2>
            <p>Write-Ahead Log (WAL) in Postgres</p>
            <p>âž• Lower publication delay (tens of ms)</p>
            <p>âž• Reduced DB load: avoids polling, dead tuples</p>
            <p>âž• Events emitted in exact commit order</p>
        </section>

        <section>
            <h2>Write-Ahead Log</h2>
            <p>â–ª append-only <b>binary</b> log of all <b>row</b>-level changes</p>
            <p>â–ª written before data files, ensures crash recovery</p>
            <p>â–ª changes grouped per transaction in commit order</p>
            <p>â–ª exists in shared buffer, flushed to on-disk files</p>
        </section>


        <section>
            <h3>Postgres process and memory architecture</h3>
            <img src="images/pg_arch.png" alt="" height="500">
            <div style="font-size: 12px;">https://www.cloudduggu.com/postgresql/architecture/</div>
        </section>

        <section>
            <h4>Transactions example</h4>
            <img src="images/transactions.png" alt="" height="500">
            <div style="font-size: 12px;">https://www.dolthub.com/blog/2024-03-08-postgres-logical-replication/</div>
        </section>

        <section>
            <h3>Corresponding WAL</h3>
            <img src="images/wal.png" alt="" height="400">
            <div style="font-size: 12px;">https://www.dolthub.com/blog/2024-03-08-postgres-logical-replication/</div>
        </section>

        <section>
            <h2>Reading from WAL</h2>
            <p>Logical replication protocol in Postgres</p>
            <p>â–ª Debezium â˜• (Server)</p>
            <p>â–ª <i>jackc/pglogrepl</i></p>
            <p>â–ª PeerDB</p>
        </section>

        <section>
            <h2>Debezium</h2>
            <p>Connectors for Kafka Connect or standalone Server</p>
            <p>Consumes DB events and can send to sinks</p>
            <p>Very mature, started in 2015 by Red Hat</p>
            <p>Open source, written in <b>Java</b></p>
        </section>

        <section>
            <h3>Debezium architectures</h3>
            <img src="images/debezium.png" alt="" height="240" style="margin-top: 0; margin-bottom: 5px;">
            <img src="images/debezium_server.png" alt="" height="280" style="margin-top: 0; margin-bottom: 5px;">
            <div style="font-size: 12px;">https://debezium.io/documentation/reference/stable/architecture.html</div>
        </section>

        <section>
            <h3>Server config example</h3>
            <pre style="font-size: 0.75em !important;"><code class="language-yaml">
 # Source: Postgres
 debezium.source.connector.class=io.debezium...PostgresConnector
 debezium.source.database.{*}=
 debezium.source.plugin.name=pgoutput
 debezium.source.publication.name=debezium_publication
 debezium.source.slot.name=debezium_slot
 debezium.source.table.include.list=public.outbox_messages

 # Sink: HTTP
 debezium.sink.type=http
 debezium.sink.http.url=http://http-listener:8080

 # Output format & single message transformation (SMT)
 debezium.format.{key,value}=json
 debezium.transforms=unwrap
            </code></pre>
        </section>

        <section>
            <h2>Outbox event router</h2>
            <p>â–ª Implemented as Kafka Connect SMT</p>
            <p>â–ª Suggests outbox table schema:</p>
            <p style="font-size: 0.9em;"><i>id, aggregateid, aggregatetype, type, payload</i></p>
            <p>â–ª Routes to Kafka topic based on <i>aggregatetype</i></p>
            <p>â–ª Uses <i>aggregateid</i> as message key</p>
        </section>

        <section>
            <h2>Debezium + Go</h2>
            <p>â–ª Kubernetes CRD + Operator for CDC</p>
            <p>â–ª Operator creates single-pod Deployment</p>
            <p>â–ª Pod is powered by Debezium,</p>
            <p>captures outbox inserts in <i>source</i> DB,</p>
            <p>publishes to message broker sink</p>
        </section>


        <section>
            <h2>Debezium Demo?</h2>
        </section>

        <section>
            <h2>jackc/pglogrepl</h2>
            <p>decodes logical replication messages</p>
            <p>includes a basic example</p>
            <p>400 stars, 200 users</p>
            <p>same author as <i>pgx</i> driver</p>
            <p>not actively maintained</p>
        </section>


        <section>
            <h2>Concepts</h2>
            <p>Publication</p>
            <p>Replication slot</p>
            <p>Decoding plugin</p>
            <p>Log sequence number (LSN)</p>
        </section>

        <section>
            <h2>Publication</h2>
            <p>definition of tables and CDC operations to be published to consumers</p>
            <pre><code class="language-sql">
 CREATE PUBLICATION pub1 FOR TABLE t1, t2;
 -- ALL TABLES
 -- WITH (publish = 'insert, update', 'delete', 'truncate');

 SELECT * FROM pg_publication;
            </code></pre>

            <p></p>

            <pre><code class="language-go">
 query := "CREATE PUBLICATION pub1 FOR TABLE t1, t2"

 result := conn.Exec(ctx, query) // low level *pgconn.PgConn
 defer result.Close()

 _, err := result.ReadAll()
            </code></pre>
        </section>

        <section>
            <h2>Replication slot</h2>
            <p>named position in WAL to track a replication consumer progress</p>

            <pre><code class="language-sql">
 SELECT pg_create_logical_replication_slot('slot', 'pgoutput');

 SELECT * FROM pg_replication_slots;
            </code></pre>

            <p></p>

            <pre><code class="language-go">
 pglogrepl.CreateReplicationSlot(ctx, conn, "slot", "pgoutput")
            </code></pre>
        </section>

        <section>
            <h2>Decoding plugins</h2>
            <p><b>pgoutput</b> - built-in, default</p>
            <p>test_decoding - built-in, only for testing</p>
            <p>wal2json - 3rd party, produces JSON</p>
            <p>decoderbufs, pglogical</p>
        </section>

        <section>
            <h2>pgoutput arguments</h2>

            <pre><code class="language-go">
 pluginArguments := []string{
    "proto_version '2'", // versions 3 and 4 are not supported by the lib
    fmt.Sprintf("publication_names '%s'", "pub1"),
    "messages 'false'",  // pg_logical_emit_message() is not used
    "streaming 'false'", // receive only committed transactions
 }
            </code></pre>
        </section>

        <section>
            <h2>Starting replication</h2>

            <p>LSN is a unique 64-bit address in WAL, e.g. 0/AC90FD</p>

            <pre><code class="language-sql">
 START_REPLICATION SLOT slot LOGICAL 0/AC90FD -- LSN where to start
    ("proto_version" '2',
    "publication_names" 'pub1',
    "messages" 'false',
    "streaming" 'false');
            </code></pre>

            <p></p>

            <pre><code class="language-go">
 sysIdent, err := pglogrepl.IdentifySystem(ctx, conn)

 pglogrepl.StartReplication(ctx, conn, "slot", sysIdent.XLogPos,
    pglogrepl.StartReplicationOptions{PluginArgs: pluginArguments})
            </code></pre>
        </section>

        <section>
            <h2>Message loop</h2>

            <pre><code class="language-go">
 for {
    var rawMsg pgproto3.BackendMessage
    rawMsg, err := conn.ReceiveMessage(ctx)

    switch msg.Data[0] {
    // XLog is historical name for WAL
    case pglogrepl.XLogDataByteID: // 'w'
        err = handleXLogData(msg.Data[1:]) // actual data

    case pglogrepl.PrimaryKeepaliveMessageByteID: // 'k'
        err = handlePrimaryKeepalive(msg.Data[1:])
    }
 }
            </code></pre>
        </section>

        <section>
            <h2>Handling data</h2>
            <p>â–ª Insert messages</p>
            <p>â–ª Relation messages</p>
            <p>â–ª Status updates:</p>
            <p style="font-size: 0.9em;">write, flush, apply positions</p>
        </section>

        <section>
            <img src="images/headaches.png" alt="" height="550">
        </section>

        <section>
            <h2>PeerDB</h2>
            <p>â–ª efficient data streaming from Postgres</p>
            <p>â–ª written in Go (and Rust)</p>
            <p>â–ª uses <i>Temporal</i> orchestration engine</p>
            <p>â–ª open-source, Elastic License 2.0 (ELv2)</p>
            <p style="font-size: 0.9em;">â–ª acquired by ClickHouse, integrated to ClickPipes</p>
        </section>


        <section>
            <h2>Pitfalls</h2>
            <p>WAL bloat</p>
            <p>Recent bug in Postgres</p>
        </section>

        <section>
            <h2>Takeaways</h2>

        </section>

        <section>
            <h2>Thank you!</h2>
            <p><a href="https://github.com/jackc/pglogrepl">jackc/pglogrepl</a></p>
            <p><a href="https://github.com/nikolayk812/pgx-outbox/tree/main/wal">nikolayk812/pgx-outbox/wal</a></p>
            <p><a href="https://github.com/PeerDB-io/peerdb">PeerDB-io/peerdb</a></p>
        </section>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/reveal.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>
    Reveal.initialize({
        width: "89%", // Use a percentage to make slides responsive
        height: "89%",
        controls: true,
        progress: true,
        slideNumber: true,
        history: true,
        center: true,
        transition: 'slide', // none/fade/slide/convex/concave/zoom
    });

    hljs.highlightAll(); // Initialize code highlighting
</script>
</body>
</html>
